name: Daily Earnings Report

on:
  # Run every day at 12:00 UTC (7:00 AM Eastern, 4:00 AM Pacific)
  schedule:
    - cron: '0 12 * * *'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:
    inputs:
      date:
        description: 'Specific date to check (YYYY-MM-DD), leave empty for yesterday'
        required: false
        default: ''

jobs:
  post-earnings:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Weekly Preview (Mondays only)
        if: github.event.schedule == '0 12 * * *' && contains('Mon', steps.date.outputs.day) || github.event_name == 'workflow_dispatch'
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          DAY=$(date +%a)
          if [ "$DAY" = "Mon" ] || [ -n "${{ github.event.inputs.date }}" ]; then
            python earnings_bot.py --weekly
          fi

      - name: Run EarningsBot
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            python earnings_bot.py --date "${{ github.event.inputs.date }}"
          else
            python earnings_bot.py
          fi

      - name: Commit buy prices
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add buy_prices.json
          git diff --cached --quiet || git commit -m "Update buy prices [skip ci]" && git push

      - name: Update Google Sheet
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
        run: python sheets_updater.py

      - name: Run PriceAlertBot
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: python price_alert_bot.py

      - name: Run CongressBot
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          CONGRESS_DISCORD_WEBHOOK_URL: ${{ secrets.CONGRESS_DISCORD_WEBHOOK_URL }}
        run: python congress_bot.py --days 7

      - name: Run CEOBot
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          CONGRESS_DISCORD_WEBHOOK_URL: ${{ secrets.CONGRESS_DISCORD_WEBHOOK_URL }}
        run: python ceo_bot.py --days 7
